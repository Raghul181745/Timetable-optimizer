<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Timetable System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body.dashboard-page {
            background: #cfdef3 url("{{ url_for('static', filename='background.jpg') }}") no-repeat center center fixed;
            background-size: cover;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #printableArea, #printableArea * {
                visibility: visible;
            }
            #printableArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="container">
        <h2>Welcome, {{ username }}</h2>
        <nav>
            <ul>
                <li><a href="{{ url_for('add_entry') }}">Add Timetable</a></li>
                <li><a href="{{ url_for('dashboard') }}">View Timetable</a></li>
                <li><a href="{{ url_for('check_slots') }}">Check Slots</a></li>
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            </ul>
        </nav>

                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        <ul class="flash-messages">
                        {% for message in messages %}
                            <li>{{ message }}</li>
                        {% endfor %}
                        </ul>
                    {% endif %}
                {% endwith %}

                <!-- Analytics Charts -->
                <div class="no-print" style="display: flex; gap: 20px; margin-bottom: 20px; height: 300px;">
                    <div style="flex: 1; background: white; padding: 15px; border-radius: 5px; border: 1px solid #ccc;">
                        <canvas id="deptChart"></canvas>
                    </div>
                    <div style="flex: 1; background: white; padding: 15px; border-radius: 5px; border: 1px solid #ccc;">
                        <canvas id="staffChart"></canvas>
                    </div>
                </div>

                <!-- View Options Section -->
                <div class="no-print" style="margin: 20px 0; padding: 15px; background: #f4f4f4; border-radius: 5px; display: flex; gap: 20px; flex-wrap: wrap;">
                    
                    <!-- Option 1: Department Wise -->
                    <form action="{{ url_for('dashboard') }}" method="GET" style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; background: #fff; flex: 1;">
                        <h3 style="margin-top: 0;">Department Wise</h3>
                        <input type="hidden" name="mode" value="dept">
                        <select name="department" required style="padding: 5px; margin-right: 5px;">
                            <option value="" disabled selected>Select Department</option>
                            {% for d in departments %}
                                <option value="{{ d.department }}" {% if request.args.get('department') == d.department %}selected{% endif %}>{{ d.department }}</option>
                            {% endfor %}
                        </select>
                        <select name="year" required style="padding: 5px; margin-right: 5px;">
                            <option value="" disabled selected>Select Year</option>
                            {% for y in years %}
                                <option value="{{ y.year }}" {% if request.args.get('year') == y.year %}selected{% endif %}>{{ y.year }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" style="padding: 5px 10px; cursor: pointer;">Show Timetable</button>
                    </form>

                    <!-- Option 2: Staff Wise -->
                    <form action="{{ url_for('dashboard') }}" method="GET" style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; background: #fff; flex: 1;">
                        <h3 style="margin-top: 0;">Staff Wise</h3>
                        <input type="hidden" name="mode" value="staff">
                        <select name="staff_name" required style="padding: 5px; margin-right: 5px;">
                            <option value="" disabled selected>Select Staff</option>
                            {% for s in staff_list %}
                                <option value="{{ s.staff_name }}" {% if request.args.get('staff_name') == s.staff_name %}selected{% endif %}>{{ s.staff_name }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" style="padding: 5px 10px; cursor: pointer;">Show Timetable</button>
                    </form>

                    <div style="flex-basis: 100%; text-align: center; margin-top: 10px;">
                        <a href="{{ url_for('dashboard') }}" style="text-decoration: none; background: #333; color: #fff; padding: 8px 15px; border-radius: 4px;">Reset / Show All Entries</a>
                    </div>
                </div>

                <!-- Grid View Display -->
                {% if grid_view %}
                <div id="printableArea">
                    <h2 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px;">{{ filter_desc }}</h2>
                    
                    <div class="no-print" style="margin-bottom: 15px;">
                        <a href="{{ url_for('export_excel', mode=request.args.get('mode'), department=request.args.get('department'), year=request.args.get('year'), staff_name=request.args.get('staff_name')) }}" style="text-decoration: none; background: #27ae60; color: white; padding: 8px 15px; border-radius: 4px; margin-right: 10px;">Export to Excel</a>
                        <button onclick="window.print()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 1em;">Print / Save as PDF</button>
                    </div>

                    <table border="1" cellpadding="8" cellspacing="0" style="width: 100%; margin-bottom: 30px; text-align: center; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #333; color: #fff;">
                                <th>Day / Time</th>
                                {% for slot in time_slots %}
                                    <th>{{ slot }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in days %}
                            <tr>
                                <td style="font-weight: bold; background: #eee;">{{ day }}</td>
                                {% for slot in time_slots %}
                                    <td>
                                        {% set entry = schedule[day][slot] %}
                                        {% if entry %}
                                            <div style="background: #e8f5e9; padding: 5px; border-radius: 4px; border: 1px solid #c8e6c9;">
                                                <strong>{{ entry.subject }}</strong><br>
                                                {% if request.args.get('mode') == 'dept' %}
                                                    <span style="font-size: 0.85em; color: #555;">{{ entry.staff_name }}</span>
                                                {% else %}
                                                    <span style="font-size: 0.85em; color: #555;">{{ entry.department }} - Y:{{ entry.year }}</span>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span style="color: #ccc;">-</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                <h2>Timetable Entries</h2>
                <table border="1" cellpadding="8" cellspacing="0">
                        <tr>
                                <th>ID</th>
                                <th>Staff Name</th>
                                <th>Department</th>
                                <th>Year</th>
                                <th>Semester</th>
                                <th>Subject</th>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Action</th>
                        </tr>
                        {% for row in entries %}
                        <tr>
                                <td>{{ row.id }}</td>
                                <td><a href="{{ url_for('dashboard', staff_name=row.staff_name) }}">{{ row.staff_name }}</a></td>
                                <td><a href="{{ url_for('dashboard', department=row.department) }}">{{ row.department }}</a></td>
                                <td><a href="{{ url_for('dashboard', year=row.year) }}">{{ row.year }}</a></td>
                                <td>{{ row.semester }}</td>
                                <td>{{ row.subject }}</td>
                                <td>{{ row.day }}</td>
                                <td>{{ row.time }}</td>
                                <td>
                                    <a href="{{ url_for('edit_entry', entry_id=row.id) }}" style="text-decoration: none; background: #3498db; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; margin-right: 5px;">Edit</a>
                                    <form method="POST" action="{{ url_for('delete_entry', entry_id=row.id) }}" style="display:inline; width:auto; padding:0; margin:0; background:none; box-shadow:none;">
                                        <button type="submit" onclick="return confirm('Are you sure you want to delete this entry?');" style="margin:0; padding:5px 10px; background:#e74c3c; font-size:12px;">Delete</button>
                                    </form>
                                </td>
                        </tr>
                        {% endfor %}
                </table>
        </div>
    <script>
        // Parse data passed from Flask (Wrapped in quotes to prevent IDE syntax errors)
        const deptData = JSON.parse('{{ dept_analytics | tojson | safe }}');
        const staffData = JSON.parse('{{ staff_analytics | tojson | safe }}');

        // 1. Department Distribution Chart (Pie)
        if (deptData && deptData.labels && deptData.labels.length > 0) {
            new Chart(document.getElementById('deptChart'), {
                type: 'pie',
                data: {
                    labels: deptData.labels,
                    datasets: [{
                        data: deptData.data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Classes per Department' }
                    }
                }
            });
        }

        // 2. Staff Workload Chart (Bar)
        if (staffData && staffData.labels && staffData.labels.length > 0) {
            new Chart(document.getElementById('staffChart'), {
                type: 'bar',
                data: {
                    labels: staffData.labels,
                    datasets: [{
                        label: 'Classes Assigned',
                        data: staffData.data,
                        backgroundColor: '#36A2EB'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: {
                        title: { display: true, text: 'Staff Workload' },
                        legend: { display: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
